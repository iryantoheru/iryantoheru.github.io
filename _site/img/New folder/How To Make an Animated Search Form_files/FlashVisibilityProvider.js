EBG.declareNamespace("RichModules");EBG.RichModules.FlashVisibilityProvider=function (resourceObjId,adConfig,options){EBG.callSuperConstructor(EBG.RichModules.FlashVisibilityProvider,this,[resourceObjId,adConfig,options]);try{var dim=this._getDimensions();this.maxVisibilityArea=dim.width*dim.height;this.pixelContainer=this._writeFlashRenderPixels();this._subscribeToEvents();}catch(e){}};EBG.RichModules.FlashVisibilityProvider.prototype={name:"Flash",pixelContainerId:null,pixels:[],maxVisibilityArea:0,_calculationTimeOut:false,_isReady:false,_loadedPixelsCounter:0,pixelCountPerAxis:5,_calculateVisibilityPercentage:function (){if(!this._isReady){return -1;}var dim=this._getDimensions();var visPercentge=0;this.maxVisibilityArea=(dim.width-2)*(dim.height-2);if(EBG.adaptor.isPageVisible()){var rect={top:dim.height-2,left:dim.width-2,bottom:0,right:0};var pixels=EBG.filterArray(this.pixels,function (p){return p.isVisible;});for(var i=0;i<pixels.length;i++){var pixel=pixels[i];rect.left=Math.min(rect.left,pixel.X);rect.right=Math.max(rect.right,pixel.X);rect.top=Math.min(rect.top,pixel.Y);rect.bottom=Math.max(rect.bottom,pixel.Y);}if(rect.top<rect.bottom&&rect.left<rect.right){visPercentge=Math.round(100*(((rect.bottom-rect.top)*(rect.right-rect.left))/this.maxVisibilityArea));}}return visPercentge;},_calculateVisibilityPercentageByAlgorithem:function (big,small){return ((1-(big+(small-(big*small))))*100);},_getViewPortMetrics:function (){return null;},getAxisHiddenAreaPercent:function (axis,span){var hiddenArea=0;for(var i=0;i<this.pixels.length;i++){if(this.pixels[i].axis==axis&&!this.pixels[i].isVisible){hiddenArea+=span;}}return hiddenArea/this.maxVisibilityArea;},_handlePixelMessage:function (args){var data={};if(args.length>0){var argsArr=args.split(",");var paramArr=["id", "isVisible", "axis"];for(var i=0;i<argsArr.length;i++){var value=argsArr[i];data[paramArr[i]]=(value.charAt(0)=='"' || value.charAt(0) == "'" || value == "false" || value == "true")?eval(value):value;}}for(var i=0;i<this.pixels.length;i++){if(this.pixels[i].id==data.id){this.pixels[i].isVisible=!!(data.isVisible==="1");if(!this.pixels[i].loaded){this.pixels[i].loaded=true;this._loadedPixelsCounter++;}this._triggerCalculation();break;}}},_writeFlashRenderPixels:function (){var pos=EBG.adaptor.getPositioningById(this._resObjId,true,this.adConfig.actualServingMode);var divId=EBG.adaptor.generateElementId("VisibilityDiv",this.adConfig.uid);var dim=this._getDimensions();var obj={tagName:EBG.Adaptors.TagNames.DIV,attributes:{id:divId,dir:'ltr', style: { position: "absolute", width: EBG.px(dim.width), height: EBG.px(dim.height), top: EBG.px(pos.Y), left: EBG.px(pos.X), "z-index":-10}},children:this._createPixelsJson()};if(typeof (this.adConfig.display)!="undefined"){obj.attributes.style.display=this.adConfig.display;}EBG.adaptor.addInlineDOM(obj,this.adConfig.placeHolderId);return EBG.adaptor.getElementById(divId);},_createPixelsJson:function (){var cord=this._getPixelCordinates();if(!cord||cord.length==0){throw "could not get cordinates for creating render pixels";}var pixelsElements=[];var pos;var tempId;for(var i=0;i<cord.length;i++){pos=cord[i];tempId=this._resObjId+"pixel" + pos.X + ":"+pos.Y;pixelsElements.push(this._buildRenderPixelJson(tempId,pos.axis,pos.X,pos.Y));this.pixels.push({id:tempId,axis:pos.axis,X:pos.X,Y:pos.Y,isVisible:false,loaded:false});}pixelsElements.push(this._createScriptTag());return pixelsElements;},_createScriptTag:function (){var tagId="handlePixel_"+this.adConfig.uid;var ref=EBG.format("EBG.ads['{0}'].visibilityMgr._visibilityProvider._handlePixelMessage",this.adConfig.uid);var handler=EBG.format("function {0}(args)",tagId);handler+=EBG.format("{ try{ if(!args||args=='null')args=''; return {0}(args);}catch(e){if(window.mmFSExceptionAlert)mmFSExceptionAlert('Command: '+command+'\\nargs: '+args.toString()+'\\n\\nexception in DoFS func:\\n'+e.message)}}",ref);var scriptElement={tagName:EBG.Adaptors.TagNames.SCRIPT,text:handler};return scriptElement;},_getPixelCordinates:function (){var dim=this._getDimensions();var arr=[];var span=(dim.width-2)/(this.pixelCountPerAxis-1);var cordVal=1;for(var i=1;i<this.pixelCountPerAxis-1;i++){arr.push({X:span*i+1,Y:1,axis:"X"});arr.push({X:span*i+1,Y:dim.height-1,axis:"X"});}span=(dim.height-2)/(this.pixelCountPerAxis-1);cordVal=1;for(var i=1;i<this.pixelCountPerAxis-1;i++){arr.push({X:1,Y:span*i+1,axis:"Y"});arr.push({X:dim.width-1,Y:span*i+1,axis:"Y"});cordVal=Math.abs(cordVal-dim.width);}return arr;},_buildRenderPixelJson:function (id,axis,left,top){var flashObj={play:"true",resId:this.adConfig.uid,resPath:this.adConfig.bigSDir+"/Res/Assets/Pixel" + EBG.flashPixelVer + "/pixel.swf",unique:0,wmode:"transparent",tagName:EBG.Adaptors.TagNames.OBJECT,attributes:{id:id,dir:"ltr",name:id,style:{position:"absolute",textAlign:"left",width:"1px",height:"1px",left:EBG.px(left),top:EBG.px(top),"z-index":1000},codebase:EBG.format("{0}download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#",EBG.protocol),version:EBG.format("{0},0,0,0",this.adConfig.flashVer)},params:{play:"true",wmode:"transparent",menu:"false",flashVars:"ebAdUID=" + this.adConfig.uid + "&id=" + id + "&axis="+axis,allowScriptAccess:"always",allowFullScreen:"true"}};if(this._isSupportShockwave()){flashObj.attributes.type="application/x-shockwave-flash";flashObj.attributes.data=flashObj.resPath;}else{flashObj.attributes.classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000";flashObj.params.movie=flashObj.resPath;}return flashObj;},_isSupportShockwave:function (){var shockwaveSupported=true;if(EBG.adaptor.browser.isIE()&&(EBG.adaptor.browser.getVersion()<11)||(EBG.adaptor.browser.getVersion()>10&&(this.adConfig.displayWin||EBG.adaptor.getDisplayWin()).document.documentMode<9)){shockwaveSupported=false;}return shockwaveSupported;},_subscribeToEvents:function (){EBG.callSuperFunction(EBG.RichModules.BasicVisibilityProvider,this,"_subscribeToEvents");EBG.eventMgr.subscribeToEvent(new EBG.Events.EventSubscription(EBG.Events.EventNames.PAGE_RESIZE,this._repositonPixels,this));},_repositonPixels:function (){var pos=EBG.adaptor.getPositioningById(this._resObjId,true,this.adConfig.actualServingMode);this.pixelContainer.style.top=EBG.px(pos.Y);this.pixelContainer.style.left=EBG.px(pos.X);},updateResourceObjId:function (resourceObjId){EBG.callSuperFunction(EBG.RichModules.FlashVisibilityProvider,this,"updateResourceObjId",[resourceObjId]);this._repositonPixels();},_triggerCalculation:function (){clearInterval(this._intervalHandler);if(this._checkPixelsLoaded()){if(!this._calculationTimeOut){var $this=this;this._calculationTimeOut=setTimeout(function (){$this._calculationTimeOut=null;var res=$this._calculateVisibilityResult();$this._dispatchCheckVisibility(res);},600);}}},_checkPixelsLoaded:function (){if(!this._isReady){this._isReady=((this.pixelCountPerAxis*2)==this._loadedPixelsCounter);}return this._isReady;},_getDimensions:function (){if(this.adConfig.ffs["CFF_ResponsiveDimensions"] && (!this.adConfig.width || !this.adConfig.height || this.adConfig.width == "100%" || this.adConfig.height == "100%")){var asset=EBG.adaptor.getElementById(this.adConfig.placeHolderId);var rect=EBG.adaptor.getBoundingClientRect(asset);return {width:rect.width,height:rect.height};}return {width:this.adConfig.width,height:this.adConfig.height};},start:function (){EBG.callSuperFunction(EBG.RichModules.FlashVisibilityProvider,this,"start");this._triggerCalculation();}};EBG.declareClass(EBG.RichModules.FlashVisibilityProvider,EBG.RichModules.BasicVisibilityProvider);